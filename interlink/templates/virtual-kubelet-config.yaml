apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.nodeName }}-virtual-kubelet-config"
  namespace: {{ .Release.Namespace }}
data:
  InterLinkConfig.yaml: |
    {{- if .Values.interlink.socket }}
    interlinkURL: {{ .Values.interlink.socket | quote }}
    interlinkPort: {{ printf "%s-1" .Values.interlink.socket | quote }}
    {{- else }}
    interlinkURL: {{ .Values.interlink.address | quote }}
    interlinkPort: {{ .Values.interlink.port | quote }}
    {{- end }}
    exportPodData: {{ .Values.interlink.exportPodData }}
    verboseLogging: true
    errorsOnlyLogging: false
    serviceAccount: "{{ .Values.nodeName }}"
    namespace: "{{ .Release.Namespace }}"
    vkTokenFile: {{ .Values.OAUTH.enabled | ternary "/opt/interlink/token" "/dev/null" }}
    resources:
      cpu: "{{ .Values.virtualNode.resources.cpus }}"
      memory: "{{ .Values.virtualNode.resources.memgib }}Gi"
      pods: "{{ .Values.virtualNode.resources.pods }}"
      accelerators:
      {{- range .Values.virtualNode.resources.accelerators }}
      - resource_type: "{{ .resource_type }}"
        model: "{{ .model }}"
        available: {{ .available }}
      {{- end }}
    http:
      insecure: {{ .Values.virtualNode.http.insecure }}
    kubeletHTTP:
      insecure: {{ .Values.virtualNode.kubeletHTTP.insecure }}
    nodeLabels:
      {{- range .Values.virtualNode.nodeLabels }}
      - "{{ . }}"
      {{- end }}
    nodeTaints:
      {{- range .Values.virtualNode.nodeTaints }}
      - key: "{{ .key }}"
        value: "{{ .value }}"
        effect: "{{ .effect }}"
      {{- end }}
---
{{- if .Values.interlink.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.nodeName }}-interlink-config"
  namespace: {{ .Release.Namespace }}
data:
  InterLinkConfig.yaml: |
    {{- if .Values.interlink.socket }}
    interlinkAddress: {{ .Values.interlink.socket | quote }}
    {{- else }}
    interlinkAddress: {{ .Values.interlink.address | quote }}
    interlinkPort: {{ .Values.interlink.port | quote }}
    {{- end }}
    {{- if .Values.plugin.socket }}
    sidecarURL: {{ .Values.plugin.socket | quote }}
    {{- else }}
    sidecarURL: {{ .Values.plugin.address | quote }}
    sidecarPort: {{ .Values.plugin.port | quote }}
    {{- end }}
    verboseLogging: true
    errorsOnlyLogging: false
    exportPodData: {{ .Values.interlink.exportPodData }}
    dataRootFolder: /data/interlink
{{- end }}
---
{{- if .Values.plugin.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Values.nodeName }}-plugin-config"
  namespace: {{ .Release.Namespace }}
data:
  plugin.yaml: |
    {{ .Values.plugin.config | indent 4 }}
{{- end }}
